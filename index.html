import React, { useState, useEffect } from 'react';

// --- Icon Komponenten (SVG-Ersatz für @expo/vector-icons) ---
const FolderIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#FFC107" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>;
const PdfFileIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#F44336" strokeWidth="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
const DeleteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#757575" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
const PrintIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#757575" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>;
const ArrowLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
const FolderPlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>;
const ScannerIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6"></path><path d="M23 20v-6h-6"></path><path d="M23 4h-6v6"></path><path d="M1 20h6v-6"></path></svg>;

// --- Hilfsfunktionen & Konfiguration ---
const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
const CURRENT_YEAR = new Date().getFullYear();
const MIETER_ADDRESS_KEYWORD = 'Anton-Günther-str.42';

// --- Hook für Fensterbreite ---
const useWindowWidth = () => {
  const [width, setWidth] = useState(window.innerWidth);
  useEffect(() => {
    const handleResize = () => setWidth(window.innerWidth);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  return width;
};

// --- Hauptkomponente: App ---
export default function App() {
  const [folders, setFolders] = useState([]);
  const [currentFolderId, setCurrentFolderId] = useState(null);
  const [modalVisible, setModalVisible] = useState(false);
  const [newFolderName, setNewFolderName] = useState('');
  const [deleteModalVisible, setDeleteModalVisible] = useState(false);
  const [itemToDelete, setItemToDelete] = useState(null);
  const width = useWindowWidth();

  useEffect(() => {
    const initializeApp = () => {
      console.log('App wird initialisiert...');
      const initialFolders = [
        { id: generateId(), name: `Steuererklärung ${CURRENT_YEAR}`, parentId: null, files: [], subFolders: [] },
        { id: generateId(), name: 'Mieter', parentId: null, files: [], subFolders: [] },
        { id: generateId(), name: 'Versicherungen', parentId: null, files: [], subFolders: [] },
      ];
      setFolders(initialFolders);
      console.log('Standardordner wurden erstellt.');
    };
    initializeApp();
  }, []);

  const handleAddFolder = () => {
    if (newFolderName.trim() === '') {
      alert('Der Ordnername darf nicht leer sein.');
      return;
    }
    const newFolder = { id: generateId(), name: newFolderName, parentId: currentFolderId, files: [], subFolders: [] };
    if (currentFolderId) {
      setFolders(prevFolders =>
        prevFolders.map(f => f.id === currentFolderId ? { ...f, subFolders: [...f.subFolders, newFolder.id] } : f).concat(newFolder)
      );
    } else {
      setFolders(prevFolders => [...prevFolders, newFolder]);
    }
    setNewFolderName('');
    setModalVisible(false);
  };

  const handleScanFile = async () => {
    console.log('Öffne Kamera zum Scannen...');
    const scanResult = {
      name: `Dokument_${new Date().toLocaleDateString('de-DE').replace(/\./g, '-')}.pdf`,
      date: new Date().toISOString(),
      ocrText: `Dies ist ein Testdokument. Rechnung für Anton-Günther-str.42. Betrag: 50,00 EUR. Datum: 01.03.${CURRENT_YEAR + 1}`,
      isTaxRelevant: true,
    };
    console.log(`Scan erfolgreich: ${scanResult.name}`);
    const newFile = { id: generateId(), name: scanResult.name, date: scanResult.date };
    setFolders(prevFolders =>
      prevFolders.map(f => f.id === currentFolderId ? { ...f, files: [...f.files, newFile] } : f)
    );
    await handleAutomation(newFile, scanResult.ocrText, scanResult.isTaxRelevant, scanResult.date);
    alert(`Dokument "${newFile.name}" wurde im aktuellen Ordner gespeichert.`);
  };

  const handleAutomation = async (file, ocrText, isTaxRelevant, fileDateStr) => {
    const fileDate = new Date(fileDateStr);
    const fileYear = fileDate.getFullYear();
    if (ocrText.includes(MIETER_ADDRESS_KEYWORD)) {
      const mieterFolder = folders.find(f => f.name === 'Mieter');
      if (mieterFolder) {
        setFolders(prevFolders =>
          prevFolders.map(f => f.id === mieterFolder.id ? { ...f, files: [...f.files, file] } : f)
        );
        console.log(`Kopie von ${file.name} wurde zum Mieter-Ordner hinzugefügt.`);
      }
    }
    if (isTaxRelevant) {
      let steuerOrdnerName = `Steuererklärung ${fileYear}`;
      let steuerFolder = folders.find(f => f.name === steuerOrdnerName);
      if (!steuerFolder) {
        console.log(`Erstelle neuen Ordner: ${steuerOrdnerName}`);
        const newSteuerFolder = { id: generateId(), name: steuerOrdnerName, parentId: null, files: [], subFolders: [] };
        setFolders(prevFolders => [...prevFolders, newSteuerFolder]);
        steuerFolder = newSteuerFolder;
      }
      setFolders(prevFolders =>
        prevFolders.map(f => f.name === steuerOrdnerName ? { ...f, files: [...f.files, file] } : f)
      );
      console.log(`Kopie von ${file.name} wurde zum Ordner ${steuerOrdnerName} hinzugefügt.`);
    }
  };

  const handleDelete = () => {
    if (!itemToDelete) return;
    const { type, id } = itemToDelete;
    if (type === 'folder') {
      setFolders(prevFolders => prevFolders.filter(f => f.id !== id && f.parentId !== id));
    } else if (type === 'file') {
      setFolders(prevFolders =>
        prevFolders.map(f => f.id === currentFolderId ? { ...f, files: f.files.filter(file => file.id !== id) } : f)
      );
    }
    setItemToDelete(null);
    setDeleteModalVisible(false);
  };
  
  const handleOpenFile = (file) => {
    // SIMULATION: In a real app, this would use a native module to open the file.
    alert(`Simuliere das Öffnen von "${file.name}" in einer externen Reader-App...`);
  };

  const openFolder = (folderId) => setCurrentFolderId(folderId);
  const goBack = () => {
    const current = folders.find(f => f.id === currentFolderId);
    if (current) setCurrentFolderId(current.parentId);
  };

  const current = folders.find(f => f.id === currentFolderId);
  const title = current ? current.name : 'Hauptmenü';
  const itemSize = (width - 48) / (width > 600 ? 5 : 3);
  const styles = getStyles(itemSize);

  let itemsToDisplay;
  if (currentFolderId) {
    if (!current) itemsToDisplay = [];
    else {
      const subFolders = folders.filter(f => current.subFolders.includes(f.id));
      const sortedFiles = [...current.files].sort((a, b) => new Date(b.date) - new Date(a.date));
      itemsToDisplay = [...subFolders, ...sortedFiles];
    }
  } else {
    itemsToDisplay = folders.filter(f => f.parentId === null);
  }

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        {currentFolderId && (
          <button onClick={goBack} style={styles.backButton}>
            <ArrowLeftIcon />
          </button>
        )}
        <p style={styles.headerTitle}>{title}</p>
        <div style={{ width: 40 }} />
      </div>

      <div style={styles.contentContainer}>
        {itemsToDisplay.length === 0 ? (
          <div style={styles.emptyContainer}><p style={styles.emptyText}>Dieser Ordner ist leer.</p></div>
        ) : (
          <div style={styles.contentGrid}>
            {itemsToDisplay.map(item => {
              const isFolder = item.hasOwnProperty('files');
              return isFolder ? (
                <div key={item.id} style={styles.gridItem} onClick={() => openFolder(item.id)}>
                  <FolderIcon />
                  <span style={styles.gridItemText}>{item.name}</span>
                  <button style={styles.deleteIcon} onClick={(e) => { e.stopPropagation(); setItemToDelete({ type: 'folder', id: item.id }); setDeleteModalVisible(true); }}>
                    <DeleteIcon />
                  </button>
                </div>
              ) : (
                <div key={item.id} style={styles.gridItem} onClick={() => handleOpenFile(item)}>
                  <PdfFileIcon />
                  <span style={styles.gridItemText}>{item.name}</span>
                  <span style={styles.dateText}>{new Date(item.date).toLocaleDateString('de-DE')}</span>
                  <button style={styles.deleteIcon} onClick={(e) => { e.stopPropagation(); setItemToDelete({ type: 'file', id: item.id }); setDeleteModalVisible(true); }}>
                    <DeleteIcon />
                  </button>
                  <button style={styles.printIcon}><PrintIcon /></button>
                </div>
              );
            })}
          </div>
        )}
      </div>

      <div style={styles.actionButtonContainer}>
        <button style={styles.actionButton} onClick={() => setModalVisible(true)}>
          <FolderPlusIcon />
          <span style={styles.actionButtonText}>Ordner</span>
        </button>
        {currentFolderId && (
          <button style={{...styles.actionButton, ...styles.scanButton}} onClick={handleScanFile}>
            <ScannerIcon />
            <span style={styles.actionButtonText}>Scannen</span>
          </button>
        )}
      </div>

      {modalVisible && (
        <div style={styles.modalContainer}>
          <div style={styles.modalView}>
            <p style={styles.modalTitle}>Neuen Ordner erstellen</p>
            <input style={styles.input} placeholder="Name des Ordners" value={newFolderName} onChange={e => setNewFolderName(e.target.value)} />
            <div style={styles.modalButtonContainer}>
              <button style={{...styles.button, ...styles.buttonClose}} onClick={() => setModalVisible(false)}>
                <span style={styles.textStyle}>Abbrechen</span>
              </button>
              <button style={{...styles.button, ...styles.buttonCreate}} onClick={handleAddFolder}>
                <span style={styles.textStyle}>Erstellen</span>
              </button>
            </div>
          </div>
        </div>
      )}

      {deleteModalVisible && (
        <div style={styles.modalContainer}>
          <div style={styles.modalView}>
            <p style={styles.modalTitle}>Wirklich löschen?</p>
            <p style={styles.modalText}>Möchten Sie das ausgewählte Element wirklich endgültig löschen?</p>
            <div style={styles.modalButtonContainer}>
              <button style={{...styles.button, ...styles.buttonClose}} onClick={() => setDeleteModalVisible(false)}>
                <span style={styles.textStyle}>Nein</span>
              </button>
              <button style={{...styles.button, ...styles.buttonDelete}} onClick={handleDelete}>
                <span style={styles.textStyle}>Ja, löschen</span>
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// --- Stylesheet-Funktion ---
const getStyles = (itemSize) => ({
  container: { display: 'flex', flexDirection: 'column', height: '100vh', backgroundColor: '#f5f5f5', fontFamily: 'sans-serif' },
  header: { display: 'flex', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', backgroundColor: '#1976D2', padding: '12px 16px', color: '#fff', boxShadow: '0 2px 4px rgba(0,0,0,0.2)' },
  headerTitle: { fontSize: '20px', fontWeight: 'bold', margin: 0 },
  backButton: { background: 'none', border: 'none', cursor: 'pointer', padding: '8px' },
  contentContainer: { flex: 1, overflowY: 'auto' },
  contentGrid: { display: 'flex', flexWrap: 'wrap', padding: '8px' },
  gridItem: { width: itemSize, height: itemSize + 20, margin: '8px', backgroundColor: '#fff', borderRadius: '12px', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', padding: '8px', boxShadow: '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24)', position: 'relative', border: 'none', cursor: 'pointer', textAlign: 'center' },
  gridItemText: { marginTop: '8px', fontSize: '12px', fontWeight: '500', color: '#333', wordBreak: 'break-word' },
  dateText: { fontSize: '10px', color: '#757575', position: 'absolute', bottom: '4px', left: '8px' },
  deleteIcon: { position: 'absolute', top: '4px', right: '4px', padding: '4px', background: 'none', border: 'none', cursor: 'pointer' },
  printIcon: { position: 'absolute', bottom: '4px', right: '4px', padding: '4px', background: 'none', border: 'none', cursor: 'pointer' },
  emptyContainer: { display: 'flex', flex: 1, justifyContent: 'center', alignItems: 'center', height: '100%' },
  emptyText: { fontSize: '16px', color: '#757575' },
  actionButtonContainer: { position: 'absolute', bottom: '30px', right: '20px', display: 'flex', flexDirection: 'column', alignItems: 'flex-end' },
  actionButton: { display: 'flex', flexDirection: 'row', backgroundColor: '#1976D2', padding: '12px 16px', borderRadius: '25px', alignItems: 'center', boxShadow: '0 2px 5px rgba(0,0,0,0.3)', border: 'none', cursor: 'pointer', color: '#fff' },
  scanButton: { backgroundColor: '#4CAF50', marginTop: '10px' },
  actionButtonText: { color: '#fff', marginLeft: '8px', fontWeight: 'bold' },
  modalContainer: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, display: 'flex', justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 1000 },
  modalView: { margin: '20px', backgroundColor: 'white', borderRadius: '20px', padding: '25px', alignItems: 'center', boxShadow: '0 2px 10px rgba(0,0,0,0.25)', width: '90%', maxWidth: '400px' },
  modalTitle: { marginBottom: '15px', textAlign: 'center', fontSize: '18px', fontWeight: 'bold', margin: 0 },
  modalText: { marginBottom: '15px', textAlign: 'center' },
  input: { width: 'calc(100% - 20px)', height: '40px', borderColor: '#ddd', borderWidth: '1px', borderRadius: '10px', padding: '0 10px', marginBottom: '20px' },
  modalButtonContainer: { display: 'flex', flexDirection: 'row', justifyContent: 'space-between', width: '100%' },
  button: { borderRadius: '10px', padding: '10px', flex: 1, margin: '0 5px', border: 'none', cursor: 'pointer' },
  buttonClose: { backgroundColor: '#757575' },
  buttonCreate: { backgroundColor: '#2196F3' },
  buttonDelete: { backgroundColor: '#f44336' },
  textStyle: { color: 'white', fontWeight: 'bold', textAlign: 'center' },
});
