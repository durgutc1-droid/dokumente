import React, { useState, useEffect, useCallback } from 'react';

// --- ICONS (as SVG components) ---
const FolderIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#FFC107" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>;
const PdfFileIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#F44336" strokeWidth="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
const ImageFileIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>;
const DeleteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>;
const PrintIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clipRule="evenodd" /></svg>;

// --- Helper Functions ---
const generateId = (prefix) => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

// --- Main App Component ---
export default function App() {
    const [folders, setFolders] = useState([]);
    const [files, setFiles] = useState([]);
    const [currentFolderId, setCurrentFolderId] = useState(null);
    const [modal, setModal] = useState({ type: null, item: null }); // type: 'addFolder' | 'delete'

    // Load state from localStorage on initial render
    useEffect(() => {
        try {
            const savedState = localStorage.getItem('aktenOrdnerState');
            if (savedState) {
                const { folders, files } = JSON.parse(savedState);
                setFolders(folders || []);
                setFiles(files || []);
            } else {
                // Initialize with default folders
                const CURRENT_YEAR = new Date().getFullYear();
                setFolders([
                    { id: generateId('folder'), name: `Steuererklärung ${CURRENT_YEAR}`, parentId: null },
                    { id: generateId('folder'), name: 'Mieter', parentId: null },
                ]);
            }
        } catch (error) {
            console.error("Failed to load state from localStorage:", error);
        }
    }, []);

    // Save state to localStorage whenever folders or files change
    useEffect(() => {
        try {
            const stateToSave = JSON.stringify({ folders, files });
            localStorage.setItem('aktenOrdnerState', stateToSave);
        } catch (error) {
            console.error("Failed to save state to localStorage:", error);
        }
    }, [folders, files]);

    const handleAddFolder = (name) => {
        if (!name.trim()) return;
        const newFolder = { id: generateId('folder'), name, parentId: currentFolderId };
        setFolders(prev => [...prev, newFolder]);
        setModal({ type: null, item: null });
    };

    const handleFileUpload = (uploadedFile) => {
        if (!uploadedFile || !currentFolderId) return;
        const newFile = {
            id: generateId('file'),
            name: uploadedFile.name,
            date: new Date().toISOString(),
            folderId: currentFolderId,
        };
        setFiles(prev => [...prev, newFile]);
    };

    const handleDelete = () => {
        if (!modal.item) return;
        const { type, id } = modal.item;

        if (type === 'file') {
            setFiles(prev => prev.filter(file => file.id !== id));
        } else if (type === 'folder') {
            const foldersToDelete = new Set([id]);
            let changed = true;
            while(changed) {
                changed = false;
                const currentSize = foldersToDelete.size;
                folders.forEach(folder => {
                    if (folder.parentId && foldersToDelete.has(folder.parentId)) {
                        foldersToDelete.add(folder.id);
                    }
                });
                if (foldersToDelete.size > currentSize) changed = true;
            }
            
            setFiles(prev => prev.filter(file => !foldersToDelete.has(file.folderId)));
            setFolders(prev => prev.filter(folder => !foldersToDelete.has(folder.id)));
        }
        setModal({ type: null, item: null });
    };
    
    const handleExport = () => {
        const dataStr = JSON.stringify({ folders, files }, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.download = 'akten-ordner-backup.json';
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
        alert('Sicherungsdatei wurde im Downloads-Ordner gespeichert.');
    };

    const handleImport = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const { folders: importedFolders, files: importedFiles } = JSON.parse(e.target.result);
                if (Array.isArray(importedFolders) && Array.isArray(importedFiles)) {
                    if (window.confirm('Möchten Sie wirklich alle aktuellen Daten durch den Inhalt der Sicherungsdatei ersetzen?')) {
                        setFolders(importedFolders);
                        setFiles(importedFiles);
                        setCurrentFolderId(null);
                        alert('Daten erfolgreich wiederhergestellt!');
                    }
                } else {
                    alert('Fehler: Die Datei hat kein gültiges Format.');
                }
            } catch (error) {
                alert('Fehler beim Lesen der Datei.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    };

    const currentFolder = folders.find(f => f.id === currentFolderId);
    const childFolders = folders.filter(f => f.parentId === currentFolderId);
    const childFiles = files.filter(f => f.folderId === currentFolderId).sort((a, b) => new Date(b.date) - new Date(a.date));

    return (
        <div className="flex flex-col h-screen bg-slate-100 font-sans">
            {/* Header */}
            <header className="bg-blue-600 text-white shadow-md p-4 flex items-center justify-between">
                <button
                    onClick={() => setCurrentFolderId(currentFolder?.parentId ?? null)}
                    className={`p-2 rounded-full hover:bg-blue-700 ${!currentFolderId ? 'invisible' : ''}`}
                >
                    <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </button>
                <h1 className="text-xl font-bold text-center truncate">{currentFolder?.name || 'Hauptmenü'}</h1>
                <div className="flex items-center space-x-2">
                    <label htmlFor="import-input" className="p-2 rounded-full hover:bg-blue-700 cursor-pointer" title="Daten Wiederherstellen">
                        <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    </label>
                    <input type="file" id="import-input" className="hidden" accept=".json" onChange={handleImport} />
                    <button onClick={handleExport} title="Daten Sichern" className="p-2 rounded-full hover:bg-blue-700">
                        <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                </div>
            </header>

            {/* Content Grid */}
            <main className="flex-grow p-4 overflow-y-auto">
                {childFolders.length === 0 && childFiles.length === 0 ? (
                    <div className="h-full flex items-center justify-center text-slate-500"><p>Dieser Ordner ist leer.</p></div>
                ) : (
                    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                        {childFolders.map(folder => (
                            <div key={folder.id} onClick={() => setCurrentFolderId(folder.id)} className="relative aspect-square bg-white rounded-lg shadow p-2 cursor-pointer text-center flex flex-col items-center justify-center">
                                <FolderIcon />
                                <span className="mt-2 text-sm font-medium text-slate-700 break-words">{folder.name}</span>
                                <div onClick={(e) => { e.stopPropagation(); setModal({ type: 'delete', item: { id: folder.id, type: 'folder' } }); }} className="absolute top-1 right-1 p-1 text-slate-400 hover:text-red-500 rounded-full"><DeleteIcon /></div>
                            </div>
                        ))}
                        {childFiles.map(file => {
                            const isPdf = file.name.toLowerCase().endsWith('.pdf');
                            return (
                                <div key={file.id} className="relative aspect-square bg-white rounded-lg shadow p-2 text-center flex flex-col items-center justify-center">
                                    {isPdf ? <PdfFileIcon /> : <ImageFileIcon />}
                                    <span className="mt-2 text-sm font-medium text-slate-700 break-words">{file.name}</span>
                                    <div onClick={(e) => { e.stopPropagation(); setModal({ type: 'delete', item: { id: file.id, type: 'file' } }); }} className="absolute top-1 right-1 p-1 text-slate-400 hover:text-red-500 rounded-full"><DeleteIcon /></div>
                                    <div onClick={() => alert('Drucken ist in diesem Prototyp nicht möglich.')} className="absolute bottom-1 right-1 p-1 text-slate-400 hover:text-blue-500 rounded-full"><PrintIcon /></div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </main>

            {/* Action Buttons */}
            <div className="fixed bottom-6 right-6 flex flex-col items-end space-y-3">
                {currentFolderId && (
                    <label htmlFor="file-upload-input" className="bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg cursor-pointer" title="Datei in Ordner hochladen">
                         <svg className="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 15l-4-4m0 0l4-4m-4 4h12" /></svg>
                    </label>
                )}
                 <input type="file" id="file-upload-input" className="hidden" accept="image/*,.pdf" onChange={(e) => handleFileUpload(e.target.files[0])} />
                <button onClick={() => setModal({ type: 'addFolder', item: null })} className="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg" title="Neuen Ordner erstellen">
                    <svg className="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                </button>
            </div>

            {/* Modals */}
            {modal.type === 'addFolder' && <AddFolderModal onAdd={handleAddFolder} onCancel={() => setModal({ type: null, item: null })} />}
            {modal.type === 'delete' && <DeleteModal onDelete={handleDelete} onCancel={() => setModal({ type: null, item: null })} itemType={modal.item.type} />}
        </div>
    );
}

// --- Modal Components ---
function AddFolderModal({ onAdd, onCancel }) {
    const [name, setName] = useState('');
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div className="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-sm">
                <h2 className="text-lg font-bold mb-4">Neuen Ordner erstellen</h2>
                <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="border rounded-md w-full p-2 mb-4" placeholder="Name des Ordners" autoFocus />
                <div className="flex justify-end space-x-2">
                    <button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded-md">Abbrechen</button>
                    <button onClick={() => onAdd(name)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">Erstellen</button>
                </div>
            </div>
        </div>
    );
}

function DeleteModal({ onDelete, onCancel, itemType }) {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div className="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-sm text-center">
                <h2 className="text-lg font-bold mb-2">Wirklich löschen?</h2>
                <p className="mb-4 text-slate-600">{`Möchten Sie das ${itemType === 'folder' ? 'Verzeichnis (inkl. Inhalt)' : 'Dokument'} wirklich löschen?`}</p>
                <div className="flex justify-center space-x-2">
                    <button onClick={onCancel} className="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded-md">Nein</button>
                    <button onClick={onDelete} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">Ja, löschen</button>
                </div>
            </div>
        </div>
    );
}
