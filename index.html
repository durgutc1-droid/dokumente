<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akten Ordner (Nur Offline)</title>
    <!-- Manifest für die Installation -->
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1.5rem; }
        .item { display: flex; flex-direction: column; align-items: center; justify-content: start; text-align: center; position: relative; }
        .item .actions { position: absolute; top: -8px; right: -8px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .item:hover .actions { opacity: 1; }
        .action-btn { background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .action-btn.delete { background-color: #ef4444; }
        .action-btn.print { background-color: #3b82f6; }
        .action-btn.summary { background-color: #8b5cf6; }
        .word-break { word-break: break-word; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .locked-folder i { filter: grayscale(1); }
        .locked-folder .lock-icon { position: absolute; bottom: 10px; right: 10px; color: rgba(0,0,0,0.4); font-size: 1.5rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <header class="flex items-center justify-between mb-4">
            <button id="back-btn" class="p-2 rounded-md hover:bg-gray-200"><i class="fas fa-arrow-left"></i></button>
            <div class="flex items-center gap-3">
                <h1 id="current-folder-name" class="text-2xl font-bold">Hauptmenü</h1>
                <div id="status-indicator" class="w-3 h-3 rounded-full transition-colors" title=""></div>
            </div>
            <div class="w-8"></div>
        </header>

        <nav class="mb-4 text-sm text-gray-500" id="breadcrumb"></nav>
        <main id="item-container" class="item-grid p-4 bg-white rounded-lg shadow-md min-h-[300px]"></main>

        <div class="fixed bottom-8 right-8 flex flex-col gap-4">
            <button id="add-folder-btn" class="bg-blue-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-blue-600"><i class="fas fa-folder-plus"></i></button>
            <button id="scan-file-btn" class="bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-green-600">
                <i class="fas fa-camera"></i>
                <span id="ai-badge" class="absolute top-0 right-0 bg-yellow-400 text-black text-xs font-bold rounded-full px-1.5 py-0.5">✨ KI</span>
            </button>
        </div>
        
        <footer class="text-center text-xs text-gray-400 mt-4">
            <p>Alle Daten werden sicher nur auf diesem Gerät gespeichert.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex-col items-center justify-center z-50">
        <video id="camera-view" class="w-full max-w-lg h-auto" autoplay playsinline></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <div class="flex gap-4 mt-4">
            <button id="capture-btn" class="bg-blue-500 text-white px-6 py-3 rounded-full text-lg shadow-lg">Foto machen</button>
            <button id="cancel-camera-btn" class="bg-gray-500 text-white px-6 py-3 rounded-full text-lg shadow-lg">Abbrechen</button>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600">Ja</button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">Nein</button>
            </div>
        </div>
    </div>
    <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <p id="input-message" class="mb-4 text-lg font-semibold"></p>
            <input id="input-field" type="text" class="w-full border border-gray-300 p-2 rounded-md mb-4">
            <div class="flex justify-end gap-4">
                <button id="input-ok" class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600">OK</button>
                <button id="input-cancel" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">Abbrechen</button>
            </div>
        </div>
    </div>
    <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">✨ KI-Zusammenfassung</h3>
            <p id="summary-text" class="mb-4 text-gray-700"></p>
            <div class="flex justify-end gap-4">
                 <button id="speak-summary-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"><i class="fas fa-volume-up mr-2"></i>Vorlesen</button>
                <button id="summary-close" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">Schließen</button>
            </div>
        </div>
    </div>
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-[60]">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-lg font-semibold">✨ Dokument wird analysiert...</p>
        </div>
    </div>

    <script>
        // Service Worker Registrierung für Offline-Funktionalität
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker erfolgreich registriert: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker Registrierung fehlgeschlagen: ', err);
                });
            });
        }

        const { jsPDF } = window.jspdf;
        const dom = {
            statusIndicator: document.getElementById('status-indicator'),
            aiBadge: document.getElementById('ai-badge'),
            scanFileBtn: document.getElementById('scan-file-btn'),
            backBtn: document.getElementById('back-btn'),
            currentFolderNameEl: document.getElementById('current-folder-name'),
            breadcrumbEl: document.getElementById('breadcrumb'),
            itemContainer: document.getElementById('item-container'),
            addFolderBtn: document.getElementById('add-folder-btn'),
            cameraModal: document.getElementById('camera-modal'),
            cameraView: document.getElementById('camera-view'),
            cameraCanvas: document.getElementById('camera-canvas'),
            captureBtn: document.getElementById('capture-btn'),
            cancelCameraBtn: document.getElementById('cancel-camera-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmYes: document.getElementById('confirm-yes'),
            confirmNo: document.getElementById('confirm-no'),
            inputModal: document.getElementById('input-modal'),
            inputMessage: document.getElementById('input-message'),
            inputField: document.getElementById('input-field'),
            inputOk: document.getElementById('input-ok'),
            inputCancel: document.getElementById('input-cancel'),
            summaryModal: document.getElementById('summary-modal'),
            summaryText: document.getElementById('summary-text'),
            summaryClose: document.getElementById('summary-close'),
            speakSummaryBtn: document.getElementById('speak-summary-btn'),
            loadingModal: document.getElementById('loading-modal'),
        };

        let currentFolderId = null;
        let db;
        let cameraStream;
        const STEUER_CATEGORIES = ["Rechnungen", "Versicherungen", "Spenden", "Sonstiges"];
        const MIETER_ADDRESS = "Anton-Günther-str.42";

        function initDB() {
            const request = indexedDB.open('AktenOrdnerDB_Offline', 6);
            request.onerror = (e) => console.error("DB Fehler:", e.target.errorCode);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                let folderStore;
                if (db.objectStoreNames.contains('folders')) {
                    folderStore = e.target.transaction.objectStore('folders');
                } else {
                    folderStore = db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true });
                }
                if (!folderStore.indexNames.contains('parentId')) {
                    folderStore.createIndex('parentId', 'parentId', { unique: false });
                }

                let fileStore;
                if (db.objectStoreNames.contains('files')) {
                    fileStore = e.target.transaction.objectStore('files');
                } else {
                    fileStore = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                }
                if (!fileStore.indexNames.contains('date')) fileStore.createIndex('date', 'date', { unique: false });
                if (!fileStore.indexNames.contains('folderId')) fileStore.createIndex('folderId', 'folderId', { unique: false });
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                ensureMieterFolder().then(render);
                updateOnlineStatus();
            };
        }

        async function render() {
            if (!db) return;
            dom.itemContainer.innerHTML = '';
            const currentFolder = await getById('folders', currentFolderId);
            dom.currentFolderNameEl.textContent = currentFolder ? currentFolder.name : 'Hauptmenü';
            dom.backBtn.style.visibility = currentFolderId === null ? 'hidden' : 'visible';
            dom.scanFileBtn.style.display = currentFolderId === null ? 'none' : 'flex';
            
            await renderBreadcrumb();
            
            const folders = await getItemsFromDB('folders', 'parentId', currentFolderId);
            const currentYear = new Date().getFullYear();
            folders.forEach(folder => {
                const isLocked = folder.name.startsWith("Steuererklärung") && parseInt(folder.name.split(" ")[1]) < currentYear;
                createFolderElement(folder, isLocked);
            });

            if (currentFolderId !== null) {
                const files = await getItemsFromDB('files', 'folderId', currentFolderId);
                files.sort((a, b) => new Date(b.date) - new Date(a.date));
                files.forEach(createFileElement);
            }
        }

        function createFolderElement(folder, isLocked = false) {
            const div = document.createElement('div');
            div.className = `item p-2 rounded-lg hover:bg-gray-100 cursor-pointer ${isLocked ? 'locked-folder' : ''}`;
            div.innerHTML = `
                <i class="fas fa-folder text-6xl text-yellow-500"></i>
                <span class="mt-2 text-sm word-break">${folder.name}</span>
                ${isLocked ? '<div class="lock-icon"><i class="fas fa-lock"></i></div>' : ''}
                <div class="actions">
                    <div class="action-btn delete" data-type="folder" data-id="${folder.id}"><i class="fas fa-times"></i></div>
                </div>`;
            div.addEventListener('click', () => navigateToFolder(folder.id));
            dom.itemContainer.appendChild(div);
        }

        function createFileElement(file) {
            const iconClass = file.type.startsWith('image/') ? 'fa-file-image text-blue-500' : 'fa-file-pdf text-red-500';
            const dateString = new Date(file.date).toLocaleDateString('de-DE');
            const div = document.createElement('div');
            div.className = 'item p-2 rounded-lg hover:bg-gray-100 cursor-pointer';
            div.innerHTML = `
                <i class="fas ${iconClass} text-6xl"></i>
                <span class="mt-2 text-sm font-semibold word-break">${file.name}</span>
                <span class="text-xs text-gray-500">${dateString}</span>
                <div class="actions">
                    <div class="action-btn summary" data-summary="${file.summary || ''}"><i class="fas fa-comment-alt"></i></div>
                    <div class="action-btn print" data-id="${file.id}"><i class="fas fa-print"></i></div>
                    <div class="action-btn delete" data-id="${file.id}"><i class="fas fa-times"></i></div>
                </div>`;
            div.addEventListener('click', (e) => {
                if (!e.target.closest('.actions')) openFile(file.id);
            });
            dom.itemContainer.appendChild(div);
        }

        async function ensureSteuerFolder(year) {
            const folderName = `Steuererklärung ${year}`;
            let steuerFolder = await findFolderByName(folderName, null);
            if (!steuerFolder) {
                steuerFolder = await addItem('folders', { name: folderName, parentId: null });
            }
            for (const cat of STEUER_CATEGORIES) {
                if (!(await findFolderByName(cat, steuerFolder.id))) {
                    await addItem('folders', { name: cat, parentId: steuerFolder.id });
                }
            }
            return steuerFolder;
        }

        async function ensureMieterFolder() {
            if (!(await findFolderByName("Mieter", null))) {
                await addItem('folders', { name: "Mieter", parentId: null });
            }
        }

        async function copyFileToSteuerFolder(file) {
            if (!file.isTaxRelevant || !file.date || !file.category) return;
            const year = new Date(file.date).getFullYear();
            await ensureSteuerFolder(year);
            const steuerFolder = await findFolderByName(`Steuererklärung ${year}`, null);
            const categoryFolder = await findFolderByName(file.category, steuerFolder.id);
            if (categoryFolder) {
                const fileCopy = { ...file, folderId: categoryFolder.id, isCopy: true, originalId: file.id };
                delete fileCopy.id;
                await addItem('files', fileCopy);
            }
        }

        async function copyFileToMieterFolder(file) {
            const mieterFolder = await findFolderByName("Mieter", null);
            if (mieterFolder) {
                const fileCopy = { ...file, folderId: mieterFolder.id, isCopy: true, originalId: file.id };
                delete fileCopy.id;
                await addItem('files', fileCopy);
            }
        }

        dom.captureBtn.addEventListener('click', async () => {
            try {
                dom.cameraCanvas.width = dom.cameraView.videoWidth;
                dom.cameraCanvas.height = dom.cameraView.videoHeight;
                dom.cameraCanvas.getContext('2d').drawImage(dom.cameraView, 0, 0, dom.cameraCanvas.width, dom.cameraCanvas.height);
                dom.cancelCameraBtn.click();
                
                let aiResult = { filename: '', isTaxRelevant: false, category: 'Sonstiges', containsAddress: false, summary: 'Keine Zusammenfassung verfügbar.' };
                if (navigator.onLine) {
                    dom.loadingModal.style.display = 'flex';
                    const base64 = dom.cameraCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
                    try {
                        aiResult = await getAiAnalysis(base64);
                    } catch (error) { console.error("Fehler bei der Gemini-Analyse:", error); }
                    dom.loadingModal.style.display = 'none';
                }
                
                const docDate = await showInput("Datum des Dokuments (YYYY-MM-DD):", new Date().toISOString().slice(0, 10));
                if (!docDate || !/^\d{4}-\d{2}-\d{2}$/.test(docDate)) return;

                const fileName = await showInput("Dateiname:", aiResult.filename || `dokument-${Date.now()}`);
                if (!fileName) return;
                
                const isTaxRelevant = await showConfirm(`KI-Vorschlag: Dieses Dokument ist ${aiResult.isTaxRelevant ? `als '${aiResult.category}' steuerrelevant` : 'nicht steuerrelevant'}. Ist das korrekt?`);
                let category = null;
                if(isTaxRelevant) {
                    category = await showInput("Bitte Kategorie bestätigen:", aiResult.category) || 'Sonstiges';
                }

                dom.cameraCanvas.toBlob(async blob => {
                    const fileData = {
                        name: fileName,
                        date: docDate,
                        folderId: currentFolderId,
                        isTaxRelevant: isTaxRelevant,
                        category: category,
                        type: blob.type,
                        data: blob,
                        summary: aiResult.summary
                    };
                    const newFile = await addItem('files', fileData);
                    if (newFile.isTaxRelevant) await copyFileToSteuerFolder(newFile);
                    if (aiResult.containsAddress) await copyFileToMieterFolder(newFile);
                    render();
                }, 'image/jpeg', 0.9);
            } catch(err) {
                console.error("Fehler im Scan-Prozess:", err);
            }
        });

        async function getAiAnalysis(base64ImageData) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const promptText = `Analysiere dieses Dokument. Antworte mit einem JSON-Objekt. 1. "filename": Ein kurzer Dateiname (Format: "Typ-Beschreibung-YYYY-MM-DD"). 2. "isTaxRelevant": boolean. 3. "category": 'Rechnungen', 'Versicherungen', 'Spenden' oder 'Sonstiges'. 4. "containsAddress": boolean, ob der Text "${MIETER_ADDRESS}" exakt enthalten ist. 5. "summary": Fasse den Inhalt in einem prägnanten deutschen Satz zusammen. JSON-Format: {"filename": "...", "isTaxRelevant": boolean, "category": "...", "containsAddress": boolean, "summary": "..."}`;
            
            const payload = {
              contents: [{ parts: [{ text: promptText }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }],
              generationConfig: { responseMimeType: "application/json" }
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed: ${response.status}`);
            const result = await response.json();
            const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(jsonString);
        }
        
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            dom.statusIndicator.className = `w-3 h-3 rounded-full transition-colors ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
            dom.statusIndicator.title = isOnline ? 'Online. KI-Funktionen sind verfügbar.' : 'Offline. KI-Funktionen sind deaktiviert.';
            dom.aiBadge.style.display = isOnline ? 'block' : 'none';
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        dom.itemContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.action-btn');
            if (!btn) return;
            e.stopPropagation();
            const id = parseInt(btn.dataset.id);
            const type = btn.dataset.type === 'folder' ? 'folder' : 'file';

            if (btn.classList.contains('delete')) {
                deleteItem(id, type);
            } else if (btn.classList.contains('print')) {
                printFile(id);
            } else if (btn.classList.contains('summary')) {
                showSummaryModal(btn.dataset.summary);
            }
        });
        
        async function printFile(fileId) {
            const file = await getById('files', fileId);
            if (!file || !file.data) return;
            const url = URL.createObjectURL(file.data);
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            iframe.onload = () => {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                setTimeout(() => { document.body.removeChild(iframe); URL.revokeObjectURL(url); }, 1000);
            };
        }

        function navigateToFolder(folderId) { currentFolderId = folderId; render(); }
        dom.backBtn.addEventListener('click', async () => { if (currentFolderId !== null) { const c = await getById('folders', currentFolderId); navigateToFolder(c.parentId); } });
        dom.addFolderBtn.addEventListener('click', async () => {
            const name = await showInput("Wie soll der neue Ordner heißen?");
            if (name) {
                try {
                    await addItem('folders', { name: name, parentId: currentFolderId });
                    render();
                } catch (err) {
                    console.error("Fehler beim Erstellen des Ordners:", err);
                }
            }
        });
        dom.scanFileBtn.addEventListener('click', async () => {
            dom.cameraModal.style.display = 'flex';
            try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); dom.cameraView.srcObject = cameraStream; } catch (err) { console.error("Kamerafehler:", err); dom.cameraModal.style.display = 'none'; }
        });
        dom.cancelCameraBtn.addEventListener('click', () => { dom.cameraModal.style.display = 'none'; if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); });
        async function openFile(fileId) { const f = await getById('files', fileId); if (f && f.data) window.open(URL.createObjectURL(f.data), '_blank'); }
        
        function showConfirm(message) {
            return new Promise((resolve) => {
                dom.confirmMessage.textContent = message;
                dom.confirmModal.style.display = 'flex';
                const onYes = () => { cleanup(); resolve(true); };
                const onNo = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    dom.confirmYes.removeEventListener('click', onYes);
                    dom.confirmNo.removeEventListener('click', onNo);
                    dom.confirmModal.style.display = 'none';
                };
                dom.confirmYes.addEventListener('click', onYes, { once: true });
                dom.confirmNo.addEventListener('click', onNo, { once: true });
            });
        }

        function showInput(message, defaultValue = "") {
            return new Promise((resolve) => {
                dom.inputMessage.textContent = message;
                dom.inputField.value = defaultValue;
                dom.inputModal.style.display = 'flex';
                dom.inputField.focus();
                const onOk = () => {
                    const value = dom.inputField.value;
                    cleanup();
                    resolve(value && value.trim() !== '' ? value.trim() : null);
                };
                const onCancel = () => { cleanup(); resolve(null); };
                const cleanup = () => {
                    dom.inputOk.removeEventListener('click', onOk);
                    dom.inputCancel.removeEventListener('click', onCancel);
                    dom.inputModal.style.display = 'none';
                };
                dom.inputOk.addEventListener('click', onOk, { once: true });
                dom.inputCancel.addEventListener('click', onCancel, { once: true });
            });
        }

        function showSummaryModal(summary) {
            dom.summaryText.textContent = summary || "Keine Zusammenfassung verfügbar.";
            dom.summaryModal.style.display = 'flex';
        }
        dom.summaryClose.addEventListener('click', () => dom.summaryModal.style.display = 'none');
        dom.speakSummaryBtn.addEventListener('click', () => {
            const textToSpeak = dom.summaryText.textContent;
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'de-DE';
                window.speechSynthesis.speak(utterance);
            }
        });

        async function deleteItem(id, type) {
            const confirmed = await showConfirm("Wollen Sie dies wirklich löschen?");
            if (confirmed) {
                if (type === 'folder') await deleteFolderContents(id);
                await deleteFromDB(type + 's', id);
                render();
            }
        }
        async function deleteFolderContents(folderId) {
            const subFolders = await getItemsFromDB('folders', 'parentId', folderId);
            for (const f of subFolders) await deleteItem(f.id, 'folder');
            const files = await getItemsFromDB('files', 'folderId', folderId);
            for (const f of files) await deleteFromDB('files', f.id);
        }
        async function renderBreadcrumb() {
            dom.breadcrumbEl.innerHTML = ''; if (currentFolderId === null) return; let path = []; let currentId = currentFolderId;
            while (currentId !== null) { const folder = await getById('folders', currentId); if (folder) { path.unshift(folder); currentId = folder.parentId; } else { break; } }
            const homeLink = document.createElement('a'); homeLink.href = '#'; homeLink.textContent = 'Hauptmenü'; homeLink.onclick = (e) => { e.preventDefault(); navigateToFolder(null); }; dom.breadcrumbEl.appendChild(homeLink);
            path.forEach(f => { dom.breadcrumbEl.append(' / '); const link = document.createElement('a'); link.href = '#'; link.textContent = f.name; link.onclick = (e) => { e.preventDefault(); navigateToFolder(f.id); }; dom.breadcrumbEl.appendChild(link); });
        }

        function getStore(storeName, mode) { return db.transaction(storeName, mode).objectStore(storeName); }
        function addItem(storeName, item) { return new Promise((resolve, reject) => { const req = getStore(storeName, 'readwrite').add(item); req.onsuccess = e => resolve({ ...item, id: e.target.result }); req.onerror = e => reject(e); }); }
        function getById(storeName, id) { if (id === null) return Promise.resolve(null); return new Promise(resolve => { getStore(storeName, 'readonly').get(id).onsuccess = e => resolve(e.target.result); }); }
        function deleteFromDB(storeName, id) { return new Promise(resolve => { getStore(storeName, 'readwrite').delete(id).onsuccess = resolve; }); }
        function getItemsFromDB(storeName, indexName, value) { return new Promise((resolve, reject) => { try { const store = getStore(storeName, 'readonly'); const req = store.index(indexName).getAll(value); req.onsuccess = e => resolve(e.target.result); req.onerror = e => reject(e); } catch(e) { reject(e); } }); }
        function findFolderByName(name, parentId) { return new Promise(resolve => { getStore('folders', 'readonly').getAll().onsuccess = e => resolve(e.target.result.find(f => f.name === name && f.parentId === parentId)); }); }

        initDB();
    </script>
</body>
</html>
