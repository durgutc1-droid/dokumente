<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligente Akten Ordner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1.5rem;
        }
        .item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
            text-align: center;
            position: relative;
        }
        .item .actions {
            position: absolute;
            top: -8px;
            right: -8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .item:hover .actions {
            opacity: 1;
        }
        .action-btn {
            background-color: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }
        .action-btn.delete { background-color: #ef4444; }
        .action-btn.print { background-color: #3b82f6; }
        .word-break { word-break: break-word; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .locked-folder i { filter: grayscale(1); }
        .locked-folder .lock-icon { position: absolute; bottom: 10px; right: 10px; color: rgba(0,0,0,0.4); font-size: 1.5rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Hauptcontainer der App -->
    <div id="app" class="max-w-4xl mx-auto p-4">
        
        <header class="flex items-center justify-between mb-4">
            <button id="back-btn" class="p-2 rounded-md hover:bg-gray-200"><i class="fas fa-arrow-left"></i></button>
            <div class="flex items-center gap-3">
                <h1 id="current-folder-name" class="text-2xl font-bold">Hauptmenü</h1>
                <div id="status-indicator" class="w-3 h-3 rounded-full transition-colors" title=""></div>
            </div>
            <div class="w-8"></div>
        </header>

        <nav class="mb-4 text-sm text-gray-500" id="breadcrumb"></nav>

        <main id="item-container" class="item-grid p-4 bg-white rounded-lg shadow-md min-h-[300px]"></main>

        <div class="fixed bottom-8 right-8 flex flex-col gap-4">
            <button id="add-folder-btn" class="bg-blue-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-blue-600 transition-transform transform hover:scale-110"><i class="fas fa-folder-plus"></i></button>
            <button id="scan-file-btn" class="bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-green-600 transition-transform transform hover:scale-110">
                <i class="fas fa-camera"></i>
                <span id="ai-badge" class="absolute top-0 right-0 bg-yellow-400 text-black text-xs font-bold rounded-full px-1.5 py-0.5">✨ KI</span>
            </button>
        </div>
        
        <footer class="text-center text-xs text-gray-400 mt-4">
            <p>Alle Daten werden sicher im lokalen Speicher Ihres Browsers gespeichert und sind offline verfügbar.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="camera-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex-col items-center justify-center z-50">
        <video id="camera-view" class="w-full max-w-lg h-auto" autoplay playsinline></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <div class="flex gap-4 mt-4">
            <button id="capture-btn" class="bg-blue-500 text-white px-6 py-3 rounded-full text-lg shadow-lg">Foto machen</button>
            <button id="cancel-camera-btn" class="bg-gray-500 text-white px-6 py-3 rounded-full text-lg shadow-lg">Abbrechen</button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600">Ja</button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">Nein</button>
            </div>
        </div>
    </div>
    
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-[60]">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-lg font-semibold">✨ Dokument wird analysiert...</p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const dom = {
            statusIndicator: document.getElementById('status-indicator'),
            aiBadge: document.getElementById('ai-badge'),
            scanFileBtn: document.getElementById('scan-file-btn'),
            backBtn: document.getElementById('back-btn'),
            currentFolderNameEl: document.getElementById('current-folder-name'),
            breadcrumbEl: document.getElementById('breadcrumb'),
            itemContainer: document.getElementById('item-container'),
            addFolderBtn: document.getElementById('add-folder-btn'),
            cameraModal: document.getElementById('camera-modal'),
            cameraView: document.getElementById('camera-view'),
            cameraCanvas: document.getElementById('camera-canvas'),
            captureBtn: document.getElementById('capture-btn'),
            cancelCameraBtn: document.getElementById('cancel-camera-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmYes: document.getElementById('confirm-yes'),
            confirmNo: document.getElementById('confirm-no'),
            loadingModal: document.getElementById('loading-modal'),
        };

        let currentFolderId = null;
        let db;
        let cameraStream;
        const STEUER_CATEGORIES = ["Rechnungen", "Versicherungen", "Spenden", "Sonstiges"];

        // --- Hauptlogik ---
        function initDB() {
            const request = indexedDB.open('AktenOrdnerDB_v2', 1);
            request.onerror = (e) => console.error("DB Fehler:", e.target.errorCode);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('folders')) db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('files')) {
                    const fileStore = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                    fileStore.createIndex('date', 'date', { unique: false });
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                render();
                updateOnlineStatus();
            };
        }

        async function render() {
            if (!db) return;
            dom.itemContainer.innerHTML = '';
            const currentFolder = await getById('folders', currentFolderId);
            dom.currentFolderNameEl.textContent = currentFolder ? currentFolder.name : 'Hauptmenü';
            dom.backBtn.style.visibility = currentFolderId === null ? 'hidden' : 'visible';
            dom.scanFileBtn.style.display = currentFolderId === null ? 'none' : 'flex';
            
            await renderBreadcrumb();
            
            const folders = await getItemsFromDB('folders', currentFolderId);
            const currentYear = new Date().getFullYear();
            folders.forEach(folder => {
                const isLocked = folder.name.startsWith("Steuererklärung") && parseInt(folder.name.split(" ")[1]) < currentYear;
                createFolderElement(folder, isLocked);
            });

            if (currentFolderId !== null) {
                const files = await getItemsFromDB('files', currentFolderId);
                // Sortieren: Neueste oben, älteste unten
                files.sort((a, b) => new Date(b.date) - new Date(a.date));
                files.forEach(createFileElement);
            }
        }

        // --- Element-Erstellung & UI ---
        function createFolderElement(folder, isLocked = false) {
            const div = document.createElement('div');
            div.className = `item p-2 rounded-lg hover:bg-gray-100 cursor-pointer ${isLocked ? 'locked-folder' : ''}`;
            div.innerHTML = `
                <i class="fas fa-folder text-6xl text-yellow-500"></i>
                <span class="mt-2 text-sm word-break">${folder.name}</span>
                ${isLocked ? '<div class="lock-icon"><i class="fas fa-lock"></i></div>' : ''}
                <div class="actions">
                    <div class="action-btn delete" data-type="folder" data-id="${folder.id}"><i class="fas fa-times"></i></div>
                </div>`;
            div.addEventListener('click', () => navigateToFolder(folder.id));
            dom.itemContainer.appendChild(div);
        }

        function createFileElement(file) {
            const iconClass = file.type.startsWith('image/') ? 'fa-file-image text-blue-500' : 'fa-file-pdf text-red-500';
            const dateString = new Date(file.date).toLocaleDateString('de-DE');
            const div = document.createElement('div');
            div.className = 'item p-2 rounded-lg hover:bg-gray-100 cursor-pointer';
            div.innerHTML = `
                <i class="fas ${iconClass} text-6xl"></i>
                <span class="mt-2 text-sm font-semibold word-break">${file.name}</span>
                <span class="text-xs text-gray-500">${dateString}</span>
                <div class="actions">
                     <div class="action-btn print" data-type="file" data-id="${file.id}"><i class="fas fa-print"></i></div>
                    <div class="action-btn delete" data-type="file" data-id="${file.id}"><i class="fas fa-times"></i></div>
                </div>`;
            div.addEventListener('click', (e) => {
                if (!e.target.closest('.actions')) openFile(file.id);
            });
            dom.itemContainer.appendChild(div);
        }

        // --- Steuer-Automatisierung ---
        async function ensureSteuerFolder(year) {
            const folderName = `Steuererklärung ${year}`;
            let steuerFolder = await findFolderByName(folderName, null);

            if (!steuerFolder) {
                steuerFolder = await addItem('folders', { name: folderName, parentId: null });
            }

            for (const cat of STEUER_CATEGORIES) {
                let catFolder = await findFolderByName(cat, steuerFolder.id);
                if (!catFolder) {
                    await addItem('folders', { name: cat, parentId: steuerFolder.id });
                }
            }
            return steuerFolder;
        }

        async function copyFileToSteuerFolder(file) {
            if (!file.isTaxRelevant || !file.date || !file.category) return;
            
            const year = new Date(file.date).getFullYear();
            await ensureSteuerFolder(year);
            const categoryFolder = await findFolderByName(file.category, (await findFolderByName(`Steuererklärung ${year}`, null)).id);

            if (categoryFolder) {
                const fileCopy = { ...file, folderId: categoryFolder.id, isCopy: true, originalId: file.id };
                delete fileCopy.id; // ID wird von IndexedDB neu generiert
                await addItem('files', fileCopy);
            }
        }

        // --- Kamera & KI ---
        dom.captureBtn.addEventListener('click', async () => {
            dom.cameraCanvas.width = dom.cameraView.videoWidth;
            dom.cameraCanvas.height = dom.cameraView.videoHeight;
            dom.cameraCanvas.getContext('2d').drawImage(dom.cameraView, 0, 0, dom.cameraCanvas.width, dom.cameraCanvas.height);
            dom.cancelCameraBtn.click();
            
            let aiResult = { filename: '', isTaxRelevant: false, category: 'Sonstiges' };
            if (navigator.onLine) {
                dom.loadingModal.style.display = 'flex';
                const base64 = dom.cameraCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
                try {
                    aiResult = await getAiAnalysis(base64);
                } catch (error) { console.error("Fehler bei der Gemini-Analyse:", error); }
                dom.loadingModal.style.display = 'none';
            }
            
            const docDate = prompt(`Bitte geben Sie das Datum des Dokuments an (YYYY-MM-DD):`, new Date().toISOString().slice(0, 10));
            if (!docDate || !/^\d{4}-\d{2}-\d{2}$/.test(docDate)) {
                alert("Ungültiges Datum. Vorgang abgebrochen.");
                return;
            }

            const fileName = prompt("Dateiname:", aiResult.filename || `dokument-${Date.now()}`);
            if (!fileName) return;
            
            const isTaxRelevant = confirm(`KI-Vorschlag: Dieses Dokument ist ${aiResult.isTaxRelevant ? `als '${aiResult.category}' steuerrelevant` : 'nicht steuerrelevant'}. Ist das korrekt?`);
            const category = isTaxRelevant ? (prompt("Bitte Kategorie bestätigen:", aiResult.category) || 'Sonstiges') : null;

            const fileData = {
                name: fileName,
                date: docDate,
                folderId: currentFolderId,
                isTaxRelevant: isTaxRelevant,
                category: category,
                type: 'image/jpeg' // Annahme
            };
            
            dom.cameraCanvas.toBlob(async blob => {
                fileData.data = blob;
                const newFile = await addItem('files', fileData);
                if (newFile.isTaxRelevant) {
                    await copyFileToSteuerFolder(newFile);
                }
                render();
            }, 'image/jpeg', 0.9);
        });

        async function getAiAnalysis(base64ImageData) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const promptText = `Analysiere dieses Dokument. Antworte mit einem JSON-Objekt. 1. Schlage einen Dateinamen vor (Format: "Typ-Beschreibung-YYYY-MM-DD"). 2. Entscheide, ob es steuerrelevant ist (true/false). 3. Klassifiziere es als 'Rechnungen', 'Versicherungen', 'Spenden' oder 'Sonstiges'. JSON-Format: {"filename": "...", "isTaxRelevant": boolean, "category": "..."}`;
            
            const payload = {
              contents: [{ parts: [{ text: promptText }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }],
              generationConfig: { responseMimeType: "application/json" }
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed: ${response.status}`);
            const result = await response.json();
            const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(jsonString);
        }

        // --- Hilfsfunktionen & Event Listeners ---
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            dom.statusIndicator.className = `w-3 h-3 rounded-full transition-colors ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
            dom.statusIndicator.title = isOnline ? 'Online. KI-Funktionen sind verfügbar.' : 'Offline. KI-Funktionen sind deaktiviert.';
            dom.aiBadge.style.display = isOnline ? 'block' : 'none';
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        dom.itemContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.action-btn');
            if (!btn) return;
            e.stopPropagation();
            const id = parseInt(btn.dataset.id);
            const type = btn.dataset.type;
            if (btn.classList.contains('delete')) {
                showConfirm("Wollen Sie dies wirklich löschen?", () => deleteItem(id, type));
            } else if (btn.classList.contains('print')) {
                printFile(id);
            }
        });
        
        async function printFile(fileId) {
            const file = await getById('files', fileId);
            if (!file || !file.data) return;
            const url = URL.createObjectURL(file.data);
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            iframe.onload = () => {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                // Workaround for some browsers where the iframe is not removed immediately
                setTimeout(() => { document.body.removeChild(iframe); URL.revokeObjectURL(url); }, 1000);
            };
        }

        // --- Boilerplate (Navigation, Modals, etc.) ---
        function navigateToFolder(folderId) { currentFolderId = folderId; render(); }
        dom.backBtn.addEventListener('click', async () => { if (currentFolderId !== null) { const c = await getById('folders', currentFolderId); navigateToFolder(c.parentId); } });
        dom.addFolderBtn.addEventListener('click', () => { const n = prompt("Name des neuen Ordners:"); if (n && n.trim() !== '') { addItem('folders', { name: n.trim(), parentId: currentFolderId }).then(render); } });
        dom.scanFileBtn.addEventListener('click', async () => {
            dom.cameraModal.style.display = 'flex';
            try { cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); dom.cameraView.srcObject = cameraStream; } catch (err) { console.error("Kamerafehler:", err); alert("Kamerazugriff fehlgeschlagen."); dom.cameraModal.style.display = 'none'; }
        });
        dom.cancelCameraBtn.addEventListener('click', () => { dom.cameraModal.style.display = 'none'; if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); });
        async function openFile(fileId) { const f = await getById('files', fileId); if (f && f.data) window.open(URL.createObjectURL(f.data), '_blank'); }
        let confirmCallback = null;
        function showConfirm(message, callback) { confirmCallback = callback; dom.confirmMessage.textContent = message; dom.confirmModal.style.display = 'flex'; }
        dom.confirmNo.addEventListener('click', () => { dom.confirmModal.style.display = 'none'; confirmCallback = null; });
        dom.confirmYes.addEventListener('click', () => { if (confirmCallback) confirmCallback(); dom.confirmModal.style.display = 'none'; confirmCallback = null; });
        async function deleteItem(id, type) {
            if (type === 'folder') { await deleteFolderContents(id); }
            await deleteFromDB(type + 's', id);
            render();
        }
        async function deleteFolderContents(folderId) {
            const subFolders = await getItemsFromDB('folders', folderId);
            for (const f of subFolders) { await deleteFolderContents(f.id); await deleteFromDB('folders', f.id); }
            const files = await getItemsFromDB('files', folderId);
            for (const f of files) { await deleteFromDB('files', f.id); }
        }
        async function renderBreadcrumb() {
            dom.breadcrumbEl.innerHTML = ''; if (currentFolderId === null) return; let path = []; let currentId = currentFolderId;
            while (currentId !== null) { const folder = await getById('folders', currentId); if (folder) { path.unshift(folder); currentId = folder.parentId; } else { break; } }
            const homeLink = document.createElement('a'); homeLink.href = '#'; homeLink.textContent = 'Hauptmenü'; homeLink.onclick = (e) => { e.preventDefault(); navigateToFolder(null); }; dom.breadcrumbEl.appendChild(homeLink);
            path.forEach(f => { dom.breadcrumbEl.append(' / '); const link = document.createElement('a'); link.href = '#'; link.textContent = f.name; link.onclick = (e) => { e.preventDefault(); navigateToFolder(f.id); }; dom.breadcrumbEl.appendChild(link); });
        }

        // --- DB Wrapper Functions ---
        function getStore(storeName, mode) { return db.transaction(storeName, mode).objectStore(storeName); }
        function addItem(storeName, item) { return new Promise((resolve, reject) => { const req = getStore(storeName, 'readwrite').add(item); req.onsuccess = (e) => resolve({ ...item, id: e.target.result }); req.onerror = (e) => reject(e); }); }
        function getById(storeName, id) { if (id === null) return null; return new Promise(resolve => { getStore(storeName, 'readonly').get(id).onsuccess = e => resolve(e.target.result); }); }
        function deleteFromDB(storeName, id) { return new Promise(resolve => { getStore(storeName, 'readwrite').delete(id).onsuccess = resolve; }); }
        function getItemsFromDB(storeName, parentId) { return new Promise(resolve => { getStore(storeName, 'readonly').getAll().onsuccess = e => resolve(e.target.result.filter(i => (storeName === 'folders' ? i.parentId : i.folderId) === parentId)); }); }
        function findFolderByName(name, parentId) { return new Promise(resolve => { getStore('folders', 'readonly').getAll().onsuccess = e => resolve(e.target.result.find(f => f.name === name && f.parentId === parentId)); }); }

        initDB();
    </script>
</body>
</html>
